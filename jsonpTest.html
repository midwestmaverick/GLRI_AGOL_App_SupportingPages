<!DOCTYPE html>
<html>
 <head>
<script src="jquery-1.12.1.min.js" charset="utf-8"></script>
<script src="EvalidatorAPI_tools.js" charset="utf-8"></script>
<script src="SR001.json" charset="utf-8"></script>
<script>
	var apiUrl = "http://apps.fs.fed.us/Evalidator/batcheval.jsp?reptype=State&lat= 0&lon= 0&radius= 0&snum=Area of forest land, in acres&sdenom=No denominator - just produce estimate.&wc=92014,102014,192014,172014,182014,252014,242014,232014,262014,272014,292014,332014,342014,362014,392014,422014,442014,502014,552014,542014,382014,462014,312014,202014&pselected=State code&rselected=Ownership group - Major&cselected=Stand-size class&ptime=Current&rtime=Current&ctime=Current&wf=&wnum=&wnumdenom=&schemaName=FS_FIADB."
	
	var outdata;
	function queryAPI_HTML(apiUrl){
		apiUrl = "https://crossorigin.me/" + apiUrl;
		$.get(apiUrl, function(data) {
			//console.log(data);
			outdata=data;
			document.getElementById("container").innerHTML = String(data);
			}
		);	
	}
	
	function returnStringArray(elementArray){
		var els = elementArray;
		var out = [];
		for(i = 0; i < els.length; i++){
			out.push(els[i].textContent.trim());
		}
		return out;
	}
	
	function parseHTMLtoJSON(){
		var evalJson = {};
		evalJson.row = [];
		var tables = document.getElementById("container").getElementsByTagName("table");
		
		//Iterate through tables in document
		for(var t = 0; t < tables.length; t++){
			var capList = tables[t].getElementsByTagName("caption");
			if(capList.length > 0){
			var caption = capList[0].textContent;
			if (caption === "Estimate:"){
				var rows = tables[t].getElementsByTagName("tr");
				evalJson.columnVariable = rows[0].textContent.trim();
				evalJson.rowVariable = tables[t].getElementsByTagName("th")[0].textContent;
				var colNames = returnStringArray(rows[1].getElementsByTagName("td"));
				
				//Iterate through rows in table to put together a row object
				for(var r = 2; r < rows.length; r++){
					var rowJson = {"column":[]};
					var rowData = rows[r].getElementsByTagName("td");
					rowJson.content = rowData[0].textContent;
						
					//Iterate through items in row to put together a single item record
					for(var rd = 1; rd < rowData.length; rd++){
						var colJson = {};
						var cellValue = Number(rowData[rd].textContent.replace(/\,/g,''));
						if(isNaN(cellValue)){cellValue = 0;}
						colJson.cellValueNumerator = cellValue;
						colJson.content = colNames[rd-1];
						rowJson.column.push(colJson);
					}
					evalJson.row.push(rowJson);
				}
				
			}else if (caption === "Sampling error percent:"){
				var rows = tables[t].getElementsByTagName("tr");
				var colNames = returnStringArray(rows[1].getElementsByTagName("td"));
				
				//Iterate through rows in table to put together a row object
				for(var r = 2; r < rows.length; r++){
					var rowData = rows[r].getElementsByTagName("td");
					var rowName = rowData[0].textContent;
						
					//Iterate through items in row to append to correct item
					for(var rd = 1; rd < rowData.length; rd++){
						var cellValue = Number(rowData[rd].textContent.replace(/\,/g,''));
						if(isNaN(cellValue)){cellValue = 0;}
						evalJson.row.filter(function(d){return d.content === rowName})[0].column.filter(function(d){return d.content === colNames[rd-1]})[0].cellSE = cellValue;
					}
				}
			}else if (caption === "Number of non-zero plots in estimate:"){
				var rows = tables[t].getElementsByTagName("tr");
				var colNames = returnStringArray(rows[1].getElementsByTagName("td"));
				
				//Iterate through rows in table to put together a row object
				for(var r = 2; r < rows.length; r++){
					var rowData = rows[r].getElementsByTagName("td");
					var rowName = rowData[0].textContent;
						
					//Iterate through items in row to append to correct item
					for(var rd = 1; rd < rowData.length; rd++){
						var cellValue = Number(rowData[rd].textContent.replace(/\,/g,''));
						if(isNaN(cellValue)){cellValue = 0;}
						evalJson.row.filter(function(d){return d.content === rowName})[0].column.filter(function(d){return d.content === colNames[rd-1]})[0].cellPlotNumerator = cellValue;
					}
				}
			}
			}
		}
		return(evalJson);
	}
	function print(stuff){console.log(stuff);}
	
	
</script>

  </head>
  <body>
	<div id="container"></div>
	<script>queryAPI_HTML(apiUrl);</script>
  </body>
</html>  